const dropArea = document.getElementById('dropArea');
const videoElement = document.getElementById('video');
const saveGifButton = document.getElementById('saveGifButton');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const spinner = document.getElementById('spinner');
const fileInput = document.getElementById('fileInput');  // New file input element

let framesArray = [];

// Default fade-in and video duration (in seconds)
const fadeInDuration = 3; // Fade-in duration (can be adjusted)
const videoDuration = 5; // Total video duration (fixed at 5 seconds)
const fps = 30; // Frames per second (30fps)

// Handle drag and drop
dropArea.addEventListener('dragover', (event) => {
    event.preventDefault();
    dropArea.classList.add('dragover');
});

dropArea.addEventListener('dragleave', () => {
    dropArea.classList.remove('dragover');
});

dropArea.addEventListener('drop', (event) => {
    event.preventDefault();
    dropArea.classList.remove('dragover');
    const file = event.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
        createVideoFromImage(file);
    }
});

// Handle paste from clipboard
document.addEventListener('paste', async (event) => {
    const items = event.clipboardData.items;
    for (let item of items) {
        if (item.type.startsWith('image/')) {
            const file = item.getAsFile();
            createVideoFromImage(file);
            break;
        }
    }
});

// Handle file input
fileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file && file.type.startsWith('image/')) {
        createVideoFromImage(file);
    }
});

// Function to create video from image with fade-in effect
async function createVideoFromImage(file) {
    spinner.style.display = 'block'; // Show spinner
    videoElement.style.display = 'none'; // Hide video initially
    saveGifButton.style.display = 'none'; // Hide the GIF button initially
    framesArray = []; // Clear frames array

    const img = new Image();
    img.src = URL.createObjectURL(file);

    img.onload = async () => {
        const frames = videoDuration * fps; // Total frames for the video
        const fadeInFrames = fadeInDuration * fps; // Frames for the fade-in effect
        const fadeOutFrames = frames - fadeInFrames; // Remaining frames for fade-out (non-fade part)

        // Set up canvas dimensions to match the image
        canvas.width = img.width;
        canvas.height = img.height;

        const stream = canvas.captureStream(fps);
        const recorder = new MediaRecorder(stream);
        const chunks = [];

        recorder.ondataavailable = (e) => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/mp4' });
            videoElement.src = URL.createObjectURL(blob);
            spinner.style.display = 'none'; // Hide spinner
            videoElement.style.display = 'block'; // Show video
            saveGifButton.style.display = 'inline-block'; // Show "Save as GIF" button
        };

        recorder.start();

        for (let i = 0; i < frames; i++) {
            // Calculate opacity for fade-in
            const opacity = i < fadeInFrames ? Math.max(1 - i / fadeInFrames, 0) : 0; // Gradual fade-in effect

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw the image
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            // Apply the opacity effect (black fade-in)
            ctx.fillStyle = `rgba(0, 0, 0, ${opacity})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Store each frame for GIF conversion
            framesArray.push(canvas.toDataURL("image/png"));

            // Wait for the next frame (simulate frame rate)
            await new Promise((resolve) => setTimeout(resolve, 1000 / fps));
        }

        recorder.stop();
    };
}

// Convert frames to GIF and download
saveGifButton.addEventListener('click', () => {
    gifshot.createGIF({
        images: framesArray,
        interval: 0.033, // about 30 fps
        gifWidth: canvas.width,
        gifHeight: canvas.height
    }, (obj) => {
        if (!obj.error) {
            const gifBlob = obj.image;
            const link = document.createElement('a');
            link.href = gifBlob;
            link.download = 'fade_in_animation.gif';
            link.click();
        }
    });
});
